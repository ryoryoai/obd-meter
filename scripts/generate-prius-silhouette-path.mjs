import fs from 'node:fs';
import path from 'node:path';

/**
 * Extracts the Prius silhouette SVG path data from `web/prius-silhouette.svg`
 * and generates a TS module used by native (Android/iOS) and web rendering.
 *
 * Why: React Native's Image pipeline does not handle web-served SVGs on native.
 */

const svgPath = path.resolve('web/prius-silhouette.svg');
const outPath = path.resolve('src/components/priusSilhouettePathData.ts');

const svg = fs.readFileSync(svgPath, 'utf8');

const viewBoxMatch = svg.match(/\bviewBox="([^"]+)"/);
if (!viewBoxMatch) throw new Error('Missing viewBox in prius-silhouette.svg');
const [minX, minY, width, height] = viewBoxMatch[1]
  .trim()
  .split(/\s+/)
  .map((v) => Number(v));
if (![minX, minY, width, height].every((n) => Number.isFinite(n))) {
  throw new Error(`Invalid viewBox: ${viewBoxMatch[1]}`);
}
if (minX !== 0 || minY !== 0) {
  throw new Error(`Unexpected viewBox origin: ${viewBoxMatch[1]}`);
}

const pathMatch = svg.match(/\bd="([^"]+)"/);
if (!pathMatch) throw new Error('Missing path d="" in prius-silhouette.svg');
const d = pathMatch[1];

const out = `// Generated by scripts/generate-prius-silhouette-path.mjs from web/prius-silhouette.svg\n` +
  `// Do not edit this file by hand.\n` +
  `\n` +
  `export const PRIUS_SILHOUETTE_VIEWBOX = { width: ${width}, height: ${height} } as const;\n` +
  `\n` +
  `// Widen the type to string to avoid a huge literal type that slows down TS.\n` +
  `export const PRIUS_SILHOUETTE_PATH_D: string = ${JSON.stringify(d)};\n`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, out, 'utf8');

console.log(`Wrote ${outPath} (d length: ${d.length})`);

